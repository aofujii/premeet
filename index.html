<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PreMeet – Meeting Preshow</title>
  <style>
    :root {
      --bg: #0b0f14;
      --fg: #e5e7eb;
      --muted: #94a3b8;
      --primary: #4f46e5;
      --accent: #22c55e;
      --card: #111827;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body { margin: 0; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN", "Noto Sans JP", Helvetica, Arial, sans-serif; background: var(--bg); color: var(--fg); }
    a { color: var(--accent); }
    header { display: flex; align-items: center; justify-content: space-between; gap: 16px; padding: 16px 20px; border-bottom: 1px solid #1f2937; }
    .brand { display: flex; align-items: center; gap: 12px; }
    .brand img { width: 36px; height: 36px; object-fit: contain; border-radius: 8px; background: #0000; }
    .title-wrap { line-height: 1.1; }
    .title { font-size: clamp(22px, 4vw, 44px); font-weight: 800; margin: 0; }
    .subtitle { margin: 2px 0 0; color: var(--muted); font-size: clamp(12px, 1.8vw, 16px); }

    .toolbar { display: flex; gap: 8px; align-items: center; }
    .btn { background: #1f2937; color: var(--fg); border: 1px solid #374151; padding: 8px 10px; border-radius: 10px; cursor: pointer; font-weight: 600; }
    .btn:active { transform: translateY(1px); }

    main { display: grid; grid-template-columns: 1.4fr 1fr; gap: 16px; padding: 16px; align-items: start; }
    .card { background: var(--card); border: 1px solid #1f2937; border-radius: 16px; padding: 16px; }

    .timer { font-variant-numeric: tabular-nums; letter-spacing: .02em; font-weight: 800; font-size: clamp(20px, 3.4vw, 36px); }
    .when { color: var(--muted); font-size: 14px; margin-top: 6px; }

    ul { margin: 8px 0 0 20px; }
    li { margin: 6px 0; }

    .badges { display: flex; flex-wrap: wrap; gap: 6px; }
    .badge { background: #111827; border: 1px solid #374151; color: var(--fg); padding: 6px 10px; border-radius: 999px; font-size: 12px; }
    .role-Host { background: var(--primary); border-color: var(--primary); }
    .role-Presenter { background: #065f46; border-color: #065f46; }

    .grid-two { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }

    /* Editor */
    .editor { max-width: 1100px; margin: 0 auto; padding: 16px; }
    .field { margin: 12px 0; }
    .field label { display: block; font-weight: 700; margin-bottom: 6px; }
    .field input[type="text"], .field input[type="datetime-local"], .field textarea, .field select { width: 100%; padding: 10px 12px; border-radius: 10px; border: 1px solid #374151; background: #0f172a; color: var(--fg); }
    .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
    .muted { color: var(--muted); font-size: 12px; }
    .row { display: flex; align-items: center; gap: 8px; }

    .yt-wrap { position: relative; width: 100%; aspect-ratio: 16/9; border-radius: 12px; overflow: hidden; border: 1px solid #1f2937; background: #0f172a; }
    .yt-wrap iframe { position: absolute; inset: 0; width: 100%; height: 100%; border: 0; }

    .qr-wrap { display:flex; align-items:center; gap:12px; }
    .qr-img { width: 156px; height: 156px; border-radius: 8px; border: 1px solid #1f2937; background:#0f172a; object-fit: contain; }

    .preset-list { display:flex; flex-wrap:wrap; gap:6px; }
    .preset-item { background:#0f172a; border:1px solid #374151; border-radius:10px; padding:6px 10px; display:flex; align-items:center; gap:6px; }

    @media (max-width: 980px) {
      main { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <noscript>
    <div style="background:#fee2e2;color:#7f1d1d;padding:12px 16px;font-weight:700;border-bottom:1px solid #ef4444;">
      JavaScriptが無効になっています。PreMeetを使用するには有効にしてください。
    </div>
  </noscript>
  <div id="app"></div>

  <script>
  // ===== Storage & Defaults =====
  const STORE_KEY = 'premeet/current';
  const PRESETS_KEY = 'premeet/presets';
  const defaultData = {
    version: '1.2.0',
    meeting: {
      title: 'Sprint Planning',
      subtitle: 'Q3 Week 10',
      startDateTime: new Date(Date.now() + 5*60*1000).toISOString(),
      countdownMode: 'toStart',
      manualSeconds: 300,
      timezone: Intl.DateTimeFormat().resolvedOptions().timeZone || 'Asia/Tokyo',
      agenda: [
        { id: 'a1', text: 'Goal & Scope', durationMin: 5 },
        { id: 'a2', text: 'Backlog Review', durationMin: 15 }
      ],
      participants: [
        { id: 'p1', name: 'Host Taro', role: 'Host' },
        { id: 'p2', name: 'Hanako', role: 'Presenter' }
      ],
      notices: [
        'This meeting may be recorded.',
        'Please stay on mute unless speaking.'
      ],
      rules: { handRaise: true, timeBox: true, noMultitask: true, chatQueue: false },
      qr: { enabled: false, url: '', size: 156, margin: 2, provider: 'external' },
      branding: { theme: 'dark', primaryColor: '#4F46E5', accentColor: '#22C55E', logoSrc: '' },
      ui: { fontScale: 1.0, clockFormat: '24h' },
      i18n: 'ja',
      youtube: { enabled: false, url: '', startSeconds: 0, mute: true, loop: false, controls: true }
    }
  };

  const load = () => {
    try {
      const raw = localStorage.getItem(STORE_KEY);
      if (!raw) return structuredClone(defaultData);
      const data = JSON.parse(raw);
      if (!data.meeting.youtube) data.meeting.youtube = structuredClone(defaultData.meeting.youtube);
      if (!data.meeting.qr) data.meeting.qr = structuredClone(defaultData.meeting.qr);
      return data;
    } catch (e) { return structuredClone(defaultData); }
  };
  const save = (data) => localStorage.setItem(STORE_KEY, JSON.stringify(data));

  const loadPresets = () => { try { return JSON.parse(localStorage.getItem(PRESETS_KEY) || '[]'); } catch { return []; } };
  const savePresets = (arr) => localStorage.setItem(PRESETS_KEY, JSON.stringify(arr));

  // ===== Utilities =====
  const el = (tag, attrs={}, children=[]) => {
    const node = document.createElement(tag);
    for (const [k,v] of Object.entries(attrs)) {
      if (k === 'class') node.className = v; else if (k === 'html') node.innerHTML = v; else if (k.startsWith('on') && typeof v === 'function') node.addEventListener(k.slice(2), v); else node.setAttribute(k, v);
    }
    for (const c of [].concat(children)) if (c!=null) node.appendChild(typeof c === 'string' ? document.createTextNode(c) : c);
    return node;
  };
  const fmtTime = (ms) => {
    const s = Math.max(0, Math.floor(ms/1000));
    const hh = String(Math.floor(s/3600)).padStart(2,'0');
    const mm = String(Math.floor((s%3600)/60)).padStart(2,'0');
    const ss = String(s%60).padStart(2,'0');
    return (hh !== '00' ? hh + ':' : '') + mm + ':' + ss;
  };
  function parseYouTubeId(url) {
    if (!url) return null;
    try {
      var u = new URL(url);
      if (u.hostname.indexOf('youtu.be') > -1) {
        var path = u.pathname;
        if (path.charAt(0) === '/') path = path.slice(1);
        return path || null;
      }
      if (u.hostname.indexOf('youtube.com') > -1) {
        var idq = u.searchParams.get('v');
        if (idq) return idq;
        var parts = u.pathname.split('/');
        var idx = parts.indexOf('embed');
        if (idx > -1 && parts[idx+1]) return parts[idx+1];
      }
      return null;
    } catch (e) { return null; }
  }
  const download = (filename, text) => {
    const a = document.createElement('a');
    a.href = URL.createObjectURL(new Blob([text], {type:'application/json'}));
    a.download = filename; a.click();
    setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
  };
  const ts = () => new Date().toISOString().replace(/[-:]/g,'').slice(0,13).replace('T','-');

  // ===== Timer Engine =====
  let rafId = null;
  const startTicker = (updateFn) => {
    const loop = () => { updateFn(); rafId = requestAnimationFrame(loop); };
    if (rafId) cancelAnimationFrame(rafId);
    rafId = requestAnimationFrame(loop);
  };
  const stopTicker = () => { if (rafId) cancelAnimationFrame(rafId); rafId = null; };

  // ===== Views =====
  const renderDisplay = (state) => {
    const { meeting } = state;
    document.body.style.setProperty('--primary', meeting.branding.primaryColor);
    document.body.style.setProperty('--accent', meeting.branding.accentColor);
    document.documentElement.style.fontSize = (meeting.ui.fontScale * 100) + '%';

    const header = el('header', {}, [
      el('div', { class: 'brand' }, [
        meeting.branding.logoSrc ? el('img', { src: meeting.branding.logoSrc, alt: 'logo' }) : null,
        el('div', { class: 'title-wrap' }, [
          el('h1', { class: 'title' }, [meeting.title || 'Untitled Meeting']),
          el('p', { class: 'subtitle' }, [meeting.subtitle || '' ])
        ])
      ]),
      el('div', { class: 'toolbar' }, [
        el('button', { class: 'btn', onClick: () => { location.hash = '#/edit'; } }, ['編集']),
        el('button', { class: 'btn', onClick: () => { if (!document.fullscreenElement) document.documentElement.requestFullscreen(); else document.exitFullscreen(); } }, ['全画面'])
      ])
    ]);

    // Timer block
    const timerText = el('div', { class: 'timer' }, ['--:--']);
    const when = el('div', { class: 'when' }, []);

    const updateTimer = () => {
      const now = Date.now();
      const start = new Date(meeting.startDateTime).getTime();
      if (meeting.countdownMode === 'toStart') {
        const diff = start - now;
        timerText.textContent = (diff >= 0 ? '開始まで ' + fmtTime(diff) : '開始済み +' + fmtTime(-diff));
        const dtf = new Intl.DateTimeFormat(undefined, { dateStyle: 'medium', timeStyle: 'short', timeZone: meeting.timezone });
        when.textContent = '開始時刻: ' + dtf.format(start);
      } else if (meeting.countdownMode === 'manualDown') {
        const remain = Math.max(0, (meeting._manualEnd || 0) - now);
        timerText.textContent = '残り ' + fmtTime(remain);
        when.textContent = '手動カウントダウン (' + Math.floor(meeting.manualSeconds) + ' 秒)';
      } else {
        const diff = now - start;
        timerText.textContent = '経過 ' + fmtTime(diff);
        when.textContent = '';
      }
    };

    const leftCard = el('div', { class: 'card' }, [
      el('h2', { style: 'margin:0 0 6px 0' }, ['タイマー']),
      timerText,
      when,
      el('h2', { style: 'margin:14px 0 8px' }, ['アジェンダ']),
      el('ul', {}, meeting.agenda.map(a => el('li', {}, ['• ' + a.text + (a.durationMin ? '（' + a.durationMin + '分）' : '')])))
    ]);

    const rightCardChildren = [
      el('h2', { style: 'margin:0 0 8px' }, ['参加者'] ),
      el('div', { class: 'badges' }, meeting.participants.map(p => el('span', { class: 'badge role-' + (p.role||'') }, [p.name + (p.role ? ' / ' + p.role : '')]))),
      el('h2', { style: 'margin:14px 0 8px' }, ['注意事項'] ),
      el('ul', {}, meeting.notices.map(n => el('li', {}, [n])))
    ];

    // Optional QR
    if (meeting.qr && meeting.qr.enabled && meeting.qr.url) {
      const size = Number(meeting.qr.size)||156; const margin = Number(meeting.qr.margin)||2;
      const api = 'https://api.qrserver.com/v1/create-qr-code/';
      const src = api + '?size=' + size + 'x' + size + '&margin=' + margin + '&data=' + encodeURIComponent(meeting.qr.url);
      rightCardChildren.push(el('h2', { style:'margin:14px 0 8px' }, ['QRコード']));
      rightCardChildren.push(el('div', { class:'qr-wrap' }, [
        el('img', { class:'qr-img', src: src, alt:'QR' }),
        el('div', { class:'muted' }, ['URL: ' + meeting.qr.url])
      ]));
    }

    const rightCard = el('div', { class: 'card' }, rightCardChildren);

    // Optional YouTube block
    let ytCard = null;
    const vid = parseYouTubeId(meeting.youtube && meeting.youtube.url);
    if (meeting.youtube && meeting.youtube.enabled && vid) {
      const params = new URLSearchParams();
      params.set('autoplay', '1');
      params.set('mute', meeting.youtube.mute ? '1' : '0');
      params.set('start', String(Math.max(0, Number(meeting.youtube.startSeconds)||0)));
      params.set('loop', meeting.youtube.loop ? '1' : '0');
      params.set('controls', meeting.youtube.controls ? '1' : '0');
      if (meeting.youtube.loop) params.set('playlist', vid);
      params.set('rel', '0'); params.set('modestbranding', '1');
      const src = 'https://www.youtube-nocookie.com/embed/' + vid + '?' + params.toString();
      ytCard = el('div', { class: 'card' }, [
        el('h2', { style: 'margin:0 0 8px' }, ['YouTube']),
        el('div', { class: 'yt-wrap' }, [ el('iframe', { src: src, title: 'YouTube video', allow: 'autoplay; encrypted-media; picture-in-picture', allowfullscreen: '' }) ])
      ]);
    }

    const layout = el('main', {}, [ leftCard, rightCard ]);
    const root = el('div', {}, [header, layout]);
    if (ytCard) layout.prepend(ytCard);

    startTicker(updateTimer);
    updateTimer();
    return root;
  };

  const renderEditor = (state) => {
    stopTicker();
    const meeting = state.meeting;

    const on = (input, path, cast) => input.addEventListener('input', function(){ set(path, cast ? cast(input.value) : input.value); });

    const set = (path, value) => {
      const keys = path.split('.');
      let obj = state; for (let i=0;i<keys.length-1;i++) obj = obj[keys[i]];
      obj[keys[keys.length-1]] = value;
      save(state);
    };

    // Fields
    const fTitle = el('input', { type:'text', value: meeting.title, placeholder:'会議タイトル' });
    const fSubtitle = el('input', { type:'text', value: meeting.subtitle, placeholder:'サブタイトル' });
    const fStart = el('input', { type:'datetime-local', value: new Date(meeting.startDateTime).toISOString().slice(0,16) });
    const fMode = el('select', {}, [
      el('option', { value:'toStart', selected: meeting.countdownMode==='toStart' }, ['開始時刻まで']),
      el('option', { value:'manualDown', selected: meeting.countdownMode==='manualDown' }, ['手動カウントダウン']),
      el('option', { value:'elapsed', selected: meeting.countdownMode==='elapsed' }, ['経過タイマー'])
    ]);
    const fManual = el('input', { type:'text', value: String(meeting.manualSeconds), placeholder:'秒（例：300）' });
    const fLogo = el('input', { type:'text', value: meeting.branding.logoSrc, placeholder:'ロゴ画像URL（任意）' });

    const fYtEnabled = el('input', { type:'checkbox', checked: !!meeting.youtube.enabled });
    const fYtUrl = el('input', { type:'text', value: meeting.youtube.url || '', placeholder:'YouTube URL（任意）' });
    const fYtStart = el('input', { type:'text', value: String(meeting.youtube.startSeconds||0), placeholder:'開始秒（任意）' });
    const fYtMute = el('input', { type:'checkbox', checked: !!meeting.youtube.mute });
    const fYtLoop = el('input', { type:'checkbox', checked: !!meeting.youtube.loop });
    const fYtControls = el('input', { type:'checkbox', checked: meeting.youtube.controls !== false });

    on(fTitle, 'meeting.title');
    on(fSubtitle, 'meeting.subtitle');
    on(fStart, 'meeting.startDateTime', function(v){ return new Date(v).toISOString(); });
    on(fMode, 'meeting.countdownMode');
    on(fManual, 'meeting.manualSeconds', function(v){ return Number(v)||0; });
    on(fLogo, 'meeting.branding.logoSrc');

    fYtEnabled.addEventListener('change', function(){ set('meeting.youtube.enabled', fYtEnabled.checked); });
    on(fYtUrl, 'meeting.youtube.url');
    on(fYtStart, 'meeting.youtube.startSeconds', function(v){ return Number(v)||0; });
    fYtMute.addEventListener('change', function(){ set('meeting.youtube.mute', fYtMute.checked); });
    fYtLoop.addEventListener('change', function(){ set('meeting.youtube.loop', fYtLoop.checked); });
    fYtControls.addEventListener('change', function(){ set('meeting.youtube.controls', fYtControls.checked); });

    function splitLines(text){ return text.split(String.fromCharCode(10)).map(function(s){ return s.trim(); }).filter(function(s){ return s; }); }

    // Agenda simple textarea (one per line)
    const fAgenda = el('textarea', { rows: 6 }, []);
    fAgenda.value = meeting.agenda.map(function(a){ return a.text; }).join('
');
    fAgenda.addEventListener('input', function(){
      const lines = splitLines(fAgenda.value);
      state.meeting.agenda = lines.map(function(t,i){ return { id:'a'+(i+1), text:t }; });
      save(state);
    });

    // Participants simple textarea (Name / Role)
    const fParts = el('textarea', { rows: 4 }, []);
    fParts.value = meeting.participants.map(function(p){ return (p.name + ' / ' + (p.role||'')).trim(); }).join('
');
    fParts.addEventListener('input', function(){
      const lines = splitLines(fParts.value);
      state.meeting.participants = lines.map(function(t,i){
        const sp = t.split(' / ');
        const name = sp[0] ? sp[0].trim() : '';
        const role = sp[1] ? sp[1].trim() : '';
        return { id:'p'+(i+1), name:name, role:role };
      });
      save(state);
    });

    const fNotices = el('textarea', { rows: 4 }, []);
    fNotices.value = meeting.notices.join('
');
    fNotices.addEventListener('input', function(){
      state.meeting.notices = splitLines(fNotices.value);
      save(state);
    });

    // QR fields
    const fQrEnabled = el('input', { type:'checkbox', checked: !!meeting.qr.enabled });
    const fQrUrl = el('input', { type:'text', value: meeting.qr.url||'', placeholder:'QRにするURL（任意）' });
    const fQrSize = el('input', { type:'text', value: String(meeting.qr.size||156), placeholder:'サイズ(px)' });
    const fQrMargin = el('input', { type:'text', value: String(meeting.qr.margin||2), placeholder:'余白(px)' });

    fQrEnabled.addEventListener('change', function(){ set('meeting.qr.enabled', fQrEnabled.checked); });
    on(fQrUrl, 'meeting.qr.url');
    on(fQrSize, 'meeting.qr.size', function(v){ return Number(v)||156; });
    on(fQrMargin, 'meeting.qr.margin', function(v){ return Number(v)||2; });

    // Presets
    const fPresetName = el('input', { type:'text', placeholder:'プリセット名（例：週次定例）' });
    const btnSavePreset = el('button', { class:'btn' }, ['プリセット保存']);
    const listWrap = el('div', { class:'preset-list' });

    const renderPresetList = () => {
      listWrap.innerHTML = '';
      const presets = loadPresets();
      if (!presets.length) { listWrap.appendChild(el('div', { class:'muted' }, ['（プリセットなし）'])); return; }
      presets.forEach((p, idx) => {
        const loadBtn = el('button', { class:'btn', onClick: ()=>{ localStorage.setItem(STORE_KEY, JSON.stringify(p.data)); location.hash = '#/'; location.reload(); } }, ['読み込み']);
        const delBtn = el('button', { class:'btn', onClick: ()=>{ if (confirm('削除しますか？: ' + p.name)) { const arr = loadPresets(); arr.splice(idx,1); savePresets(arr); renderPresetList(); } } }, ['削除']);
        listWrap.appendChild(el('div', { class:'preset-item' }, [ el('span', {}, [p.name]), loadBtn, delBtn ]));
      });
    };
    renderPresetList();

    btnSavePreset.addEventListener('click', ()=>{
      const name = fPresetName.value.trim();
      if (!name) { alert('プリセット名を入力してください'); return; }
      const arr = loadPresets();
      arr.push({ id: 'ps_'+Date.now(), name: name, data: load() });
      savePresets(arr); renderPresetList(); fPresetName.value=''; alert('保存しました');
    });

    // Export / Import
    const btnExport = el('button', { class:'btn' }, ['JSONエクスポート']);
    btnExport.addEventListener('click', ()=>{
      const json = JSON.stringify(load(), null, 2);
      download('premeet-' + ts() + '.json', json);
    });

    const fileImport = el('input', { type:'file', accept:'application/json' });
    fileImport.addEventListener('change', async ()=>{
      const file = fileImport.files[0]; if (!file) return;
      try {
        const text = await file.text();
        const data = JSON.parse(text);
        if (!data || !data.meeting) throw new Error('Invalid JSON');
        if (!confirm('現在の設定をインポートした内容で置き換えます。よろしいですか？')) return;
        save(data); alert('インポートしました'); location.hash = '#/'; location.reload();
      } catch(e) { alert('読み込みに失敗しました: ' + e.message); }
    });

    const btnPreview = el('button', { class:'btn', onClick: ()=>{ location.hash = '#/'; } }, ['プレビューへ']);
    const btnStartManual = el('button', { class:'btn', onClick: ()=>{
      const end = Date.now() + (Number(state.meeting.manualSeconds)||0)*1000;
      state.meeting._manualEnd = end; save(state);
      alert('手動カウントダウ
ンを開始しました');
    } }, ['手動カウント開始']);

    const wrap = el('div', { class:'editor' }, [
      el('h1', {}, ['PreMeet 設定'] ),
      el('div', { class:'grid-3' }, [
        el('div', { class:'field' }, [ el('label', {}, ['タイトル']), fTitle ]),
        el('div', { class:'field' }, [ el('label', {}, ['サブタイトル']), fSubtitle ]),
        el('div', { class:'field' }, [ el('label', {}, ['開始日時']), fStart ])
      ]),
      el('div', { class:'grid-3' }, [
        el('div', { class:'field' }, [ el('label', {}, ['タイマーモード']), fMode ]),
        el('div', { class:'field' }, [ el('label', {}, ['手動カウントダウン（秒）']), fManual, el('div', { class:'muted' }, ['手動モードの時のみ有効']) ]),
        el('div', { class:'field' }, [ el('label', {}, ['ロゴURL（任意）']), fLogo ])
      ]),

      el('div', { class:'grid-two' }, [
        el('div', { class:'field' }, [ el('label', {}, ['アジェンダ（1行=1項目）']), fAgenda ]),
        el('div', { class:'field' }, [ el('label', {}, ['参加者（例：山田太郎 / Host）']), fParts ])
      ]),

      el('div', { class:'field' }, [ el('label', {}, ['注意事項（1行=1項目）']), fNotices ]),

      el('div', { class:'card', style:'margin-top:12px' }, [
        el('h2', { style:'margin:0 0 8px' }, ['YouTube 埋め込み（任意）']),
        el('div', { class:'row' }, [ fYtEnabled, el('label', { style:'user-select:none' }, [' 有効にする ']) ]),
        el('div', { class:'grid-3' }, [
          el('div', { class:'field' }, [ el('label', {}, ['URL']), fYtUrl ]),
          el('div', { class:'field' }, [ el('label', {}, ['開始秒']), fYtStart ]),
          el('div', { class:'field' }, [ el('label', {}, ['オプション']), el('div', {}, [
            el('label', { class:'row' }, [ fYtMute, el('span', {}, ['ミュート']) ]),
            el('label', { class:'row' }, [ fYtLoop, el('span', {}, ['ループ']) ]),
            el('label', { class:'row' }, [ fYtControls, el('span', {}, ['コントロール表示']) ])
          ]) ])
        ]),
        el('p', { class:'muted' }, ['* プライバシー強化のため youtube-nocookie.com を使用します。'])
      ]),

      el('div', { class:'card', style:'margin-top:12px' }, [
        el('h2', { style:'margin:0 0 8px' }, ['QRコード（任意・外部生成API使用）']),
        el('div', { class:'row' }, [ fQrEnabled, el('label', { style:'user-select:none' }, [' 有効にする ']) ]),
        el('div', { class:'grid-3' }, [
          el('div', { class:'field' }, [ el('label', {}, ['URL']), fQrUrl ]),
          el('div', { class:'field' }, [ el('label', {}, ['サイズ(px)']), fQrSize ]),
          el('div', { class:'field' }, [ el('label', {}, ['余白(px)']), fQrMargin ])
        ]),
        el('p', { class:'muted' }, ['* 表示時に api.qrserver.com から画像を読み込みます（オフライン不可）。社外共有URLのみの利用を推奨します。'])
      ]),

      el('div', { class:'card', style:'margin-top:12px' }, [
        el('h2', { style:'margin:0 0 8px' }, ['プリセット管理 / エクスポート・インポート']),
        el('div', { class:'grid-3' }, [
          el('div', { class:'field' }, [ el('label', {}, ['プリセット名']), fPresetName ]),
          el('div', { class:'field' }, [ el('label', {}, ['保存']), btnSavePreset ]),
          el('div', { class:'field' }, [ el('label', {}, ['一覧']), listWrap ])
        ]),
        el('div', { class:'row', style:'gap:8px; flex-wrap:wrap' }, [ btnExport, fileImport ])
      ]),

      el('div', { style:'display:flex; gap:8px; margin-top:12px' }, [ btnPreview, btnStartManual ])
    ]);

    return wrap;
  };

  // ===== Router =====
  const mount = () => {
    try {
      const state = load();
      const container = document.getElementById('app');
      container.innerHTML = '';
      const route = location.hash.replace('#','');
      const view = (route === '/edit') ? renderEditor(state) : renderDisplay(state);
      container.appendChild(view);
    } catch (err) {
      const container = document.getElementById('app');
      container.innerHTML = `<div style="background:#fef3c7;color:#7c2d12;border:1px solid #f59e0b;padding:12px;border-radius:12px;max-width:960px;margin:16px auto;">
        <strong>初期化エラー</strong><br/>${(err && err.message) ? err.message : String(err)}
      </div>`;
      console.error(err);
    }
  };
  window.addEventListener('hashchange', mount);
  window.addEventListener('DOMContentLoaded', () => { if (!location.hash) location.hash = '#/'; mount(); });

  // On-screen error capture（本番では消してOK）
  window.addEventListener('error', (e)=>{
    const el = document.getElementById('app');
    if (!el) return;
    el.insertAdjacentHTML('afterbegin', `<div style="background:#fee2e2;color:#7f1d1d;border:1px solid #ef4444;padding:10px;border-radius:12px;max-width:960px;margin:12px auto;">
      <strong>ランタイムエラー</strong>: ${e.message}
    </div>`);
  });

  // Keyboard shortcuts
  window.addEventListener('keydown', (e) => {
    if (e.key === 'F' || e.key === 'f') {
      e.preventDefault(); if (!document.fullscreenElement) document.documentElement.requestFullscreen(); else document.exitFullscreen();
    }
    if (e.key === '+') { const d = load(); d.meeting.ui.fontScale = Math.min(1.4, (d.meeting.ui.fontScale||1)+0.05); save(d); mount(); }
    if (e.key === '-') { const d = load(); d.meeting.ui.fontScale = Math.max(0.8, (d.meeting.ui.fontScale||1)-0.05); save(d); mount(); }
  });
  </script>
</body>
</html>
